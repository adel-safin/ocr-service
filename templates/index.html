<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR –°–µ—Ä–≤–∏—Å - –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</title>
    <!-- PDF.js –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 40px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #666;
            font-size: 0.9em;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            font-weight: 600;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            margin-top: 40px;
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .result-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .result-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .quality-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin: 5px;
        }
        
        .quality-high {
            background: #4caf50;
            color: white;
        }
        
        .quality-medium {
            background: #ff9800;
            color: white;
        }
        
        .quality-low {
            background: #f44336;
            color: white;
        }
        
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .warning-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 5px;
        }
        
        .warning-text {
            color: #856404;
        }
        
        .area-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .area-coords {
            font-family: monospace;
            background: white;
            padding: 8px;
            border-radius: 5px;
            margin-top: 8px;
            font-size: 0.9em;
        }
        
        .text-output {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .file-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .file-info strong {
            color: #2e7d32;
        }
        
        .corrections-list {
            list-style: none;
            padding: 0;
        }
        
        .corrections-list li {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
        
        .corrections-list .from {
            color: #f44336;
            text-decoration: line-through;
        }
        
        .corrections-list .to {
            color: #4caf50;
            font-weight: 600;
        }
        
        .preview-section {
            margin-top: 30px;
            display: none;
        }
        
        .preview-section.show {
            display: block;
        }
        
        .preview-container {
            position: relative;
            border: 2px solid #667eea;
            border-radius: 10px;
            overflow: visible;
            background: #f5f5f5;
            margin-bottom: 20px;
            min-height: 200px;
            display: inline-block;
            width: 100%;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 600px;
            height: auto;
            display: block;
        }
        
        .preview-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            pointer-events: auto;
            z-index: 10;
            touch-action: none;
        }
        
        .preview-message {
            padding: 40px;
            text-align: center;
            color: #666;
        }
        
        .preview-controls {
            background: white;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-small:hover {
            background: #764ba2;
        }
        
        .selected-areas {
            margin-top: 15px;
        }
        
        .area-item {
            background: #e3f2fd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #2196f3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .area-item button {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .important-data {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .important-data h3 {
            color: #e65100;
            margin-bottom: 15px;
        }
        
        .data-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #ff9800;
        }
        
        .data-label {
            font-weight: 600;
            color: #e65100;
            margin-right: 10px;
        }
        
        .data-value {
            color: #333;
            font-family: monospace;
        }
        
        .data-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .data-tag {
            background: #ff9800;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç OCR –°–µ—Ä–≤–∏—Å</h1>
            <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞ –∏ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π</p>
        </div>
        
        <div class="content">
            <form id="uploadForm">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
                    <div class="upload-hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: PDF, JPG, PNG, BMP</div>
                    <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.bmp" required>
                </div>
                
                <div class="file-info" id="fileInfo" style="display: none;">
                    <strong>–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª:</strong> <span id="fileName"></span><br>
                    <strong>–†–∞–∑–º–µ—Ä:</strong> <span id="fileSize"></span>
                </div>
                
                <div class="form-group">
                    <label for="template">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <select id="template">
                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                        <option value="certificate">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</option>
                        <option value="act_aosr">–ê–∫—Ç –ê–û–°–†</option>
                        <option value="act_vneshniy">–ê–∫—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –æ—Å–º–æ—Ç—Ä–∞</option>
                        <option value="act_vhodnoy">–ê–∫—Ç –≤—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è</option>
                        <option value="passport">–ü–∞—Å–ø–æ—Ä—Ç</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="requiredFields">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <input type="text" id="requiredFields" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: ogrn, inn, date">
                </div>
                
                <button type="submit" class="btn" id="submitBtn">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
            </form>
            
            <div class="preview-section" id="previewSection">
                <h3 style="margin-bottom: 15px; color: #667eea;">üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
                <div class="preview-container" id="previewContainer">
                    <img id="previewImage" class="preview-image" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                    <canvas id="previewCanvas" class="preview-canvas"></canvas>
                </div>
                <div class="preview-controls">
                    <button class="btn-small" id="clearAreasBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏—è</button>
                    <span id="areasCount">–í—ã–¥–µ–ª–µ–Ω–æ –æ–±–ª–∞—Å—Ç–µ–π: 0</span>
                </div>
                <div class="selected-areas" id="selectedAreas"></div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...</p>
            </div>
            
                <div class="results" id="results">
                    <div class="result-section" id="warningsSection" style="display: none;">
                        <h3>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</h3>
                        <div id="warningsInfo"></div>
                    </div>
                    
                    <div class="result-section" id="selectedAreasSection" style="display: none;">
                        <h3>üéØ –í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ (DPI 900)</h3>
                        <div id="selectedAreasInfo"></div>
                    </div>
                    
                    <div class="result-section">
                        <h3>üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</h3>
                        <div class="text-output" id="textOutput"></div>
                    </div>
                </div>
        </div>
    </div>
    
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadForm = document.getElementById('uploadForm');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        let selectedAreas = [];
        let isDrawing = false;
        let startX = 0;
        let startY = 0;
        let currentRect = null;
        
        function handleFileSelect(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            const previewSection = document.getElementById('previewSection');
            const container = document.getElementById('previewContainer');
            
            if (file.type.startsWith('image/')) {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                container.innerHTML = '<img id="previewImage" class="preview-image" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"><canvas id="previewCanvas" class="preview-canvas"></canvas>';
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('previewImage');
                    const canvas = document.getElementById('previewCanvas');
                    
                    if (img && canvas) {
                        img.src = e.target.result;
                        img.style.display = 'block';
                        img.style.pointerEvents = 'none'; // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
                        
                        img.onload = () => {
                            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                            setTimeout(() => {
                                setupPreviewCanvas();
                                previewSection.classList.add('show');
                                previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }, 200);
                        };
                    }
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                // –î–ª—è PDF –∏—Å–ø–æ–ª—å–∑—É–µ–º PDF.js
                container.innerHTML = '<div id="pdfPreview" style="padding: 20px; text-align: center;"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ PDF...</p></div>';
                previewSection.classList.add('show');
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ PDF.js
                        if (typeof pdfjsLib === 'undefined') {
                            throw new Error('PDF.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                        }
                        
                        const arrayBuffer = e.target.result;
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        const page = await pdf.getPage(1);
                        
                        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Ç–æ—á–∫–∞—Ö (1/72 –¥—é–π–º–∞)
                        const viewport72 = page.getViewport({ scale: 1.0 });
                        const pageWidthPoints = viewport72.width;
                        const pageHeightPoints = viewport72.height;
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è DPI 300: 300 DPI = 300/72 = 4.167 —Ç–æ—á–µ–∫ –Ω–∞ –ø–∏–∫—Å–µ–ª—å
                        // –ù–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–∏–π –º–∞—Å—à—Ç–∞–± (1.5 –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
                        const displayScale = 1.5;
                        const viewport = page.getViewport({ scale: displayScale });
                        
                        // –†–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã PDF –ø—Ä–∏ DPI 300 (–¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
                        // 1 —Ç–æ—á–∫–∞ = 1/72 –¥—é–π–º–∞, –ø—Ä–∏ 300 DPI = 300/72 = 4.167 –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ —Ç–æ—á–∫—É
                        const dpi300Scale = 300 / 72;  // ‚âà 4.167
                        const pdfRealWidth = pageWidthPoints * dpi300Scale;
                        const pdfRealHeight = pageHeightPoints * dpi300Scale;
                        
                        console.log(`PDF –∑–∞–≥—Ä—É–∂–µ–Ω: —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageWidthPoints.toFixed(0)}x${pageHeightPoints.toFixed(0)} —Ç–æ—á–µ–∫, DPI 300 —Ä–∞–∑–º–µ—Ä ${pdfRealWidth.toFixed(0)}x${pdfRealHeight.toFixed(0)} –ø–∏–∫—Å–µ–ª–µ–π`);
                        
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        await page.render({
                            canvasContext: ctx,
                            viewport: viewport
                        }).promise;
                        
                        container.innerHTML = '';
                        canvas.id = 'pdfPreviewCanvas';
                        canvas.className = 'preview-image';
                        canvas.style.maxWidth = '100%';
                        canvas.style.height = 'auto';
                        canvas.style.display = 'block';
                        canvas.style.pointerEvents = 'none'; // PDF canvas –Ω–µ –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
                        container.appendChild(canvas);
                        
                        console.log(`PDF —Ä–µ–Ω–¥–µ—Ä: —Ä–∞–∑–º–µ—Ä canvas ${canvas.width}x${canvas.height}, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä ${canvas.offsetWidth}x${canvas.offsetHeight}`);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º canvas –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
                        // –í–ê–ñ–ù–û: –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —Ä–∞–∑–º–µ—Ä—ã, —á—Ç–æ –∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞—Å—à—Ç–∞–± 1.5)
                        // –†–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã PDF (DPI 300) –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                        const selectionCanvas = document.createElement('canvas');
                        selectionCanvas.id = 'previewCanvas';
                        selectionCanvas.className = 'preview-canvas';
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω–æ–≥–æ canvas (–¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è)
                        selectionCanvas.width = canvas.width;
                        selectionCanvas.height = canvas.height;
                        selectionCanvas.style.width = canvas.width + 'px';
                        selectionCanvas.style.height = canvas.height + 'px';
                        selectionCanvas.style.position = 'absolute';
                        selectionCanvas.style.top = '0';
                        selectionCanvas.style.left = '0';
                        selectionCanvas.style.zIndex = '10';
                        container.appendChild(selectionCanvas);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ PDF –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
                        canvas.dataset.pdfRealWidth = pdfRealWidth;
                        canvas.dataset.pdfRealHeight = pdfRealHeight;
                        canvas.dataset.pdfDisplayWidth = canvas.width;
                        canvas.dataset.pdfDisplayHeight = canvas.height;
                        
                        console.log(`Canvas –≤—ã–¥–µ–ª–µ–Ω–∏—è: —Ä–∞–∑–º–µ—Ä ${selectionCanvas.width}x${selectionCanvas.height}, —Ä–µ–∞–ª—å–Ω—ã–π PDF ${pdfRealWidth.toFixed(0)}x${pdfRealHeight.toFixed(0)}`);
                        
                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è PDF
                        setTimeout(() => {
                            setupPreviewCanvas();
                        }, 400);
                        
                        previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PDF:', error);
                        container.innerHTML = '<div class="preview-message">üìÑ –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å PDF –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞.<br>–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å –æ–±–ª–∞—Å—Ç–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.</div>';
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
                container.innerHTML = '<div class="preview-message">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞</div>';
                previewSection.classList.add('show');
            }
        }
        
        function setupPreviewCanvas() {
            const canvas = document.getElementById('previewCanvas');
            const container = document.getElementById('previewContainer');
            
            if (!canvas || !container) return;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (img –∏–ª–∏ canvas —Å PDF)
            const img = document.getElementById('previewImage');
            let baseElement = img;
            
            if (!baseElement) {
                // –ò—â–µ–º canvas —Å PDF (–ø–µ—Ä–≤—ã–π canvas –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ previewCanvas)
                const pdfCanvas = container.querySelector('canvas:not(#previewCanvas)');
                if (pdfCanvas) {
                    baseElement = pdfCanvas;
                }
            }
            
            if (!baseElement) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –±–∞–∑–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                const rect = container.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –±–∞–∑–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                const baseWidth = baseElement.offsetWidth || baseElement.width || baseElement.clientWidth;
                const baseHeight = baseElement.offsetHeight || baseElement.height || baseElement.clientHeight;
                
                canvas.width = baseWidth;
                canvas.height = baseHeight;
                canvas.style.width = baseWidth + 'px';
                canvas.style.height = baseHeight + 'px';
            }
            
            const ctx = canvas.getContext('2d');
            
            // –û—á–∏—â–∞–µ–º canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±–ª–∞—Å—Ç–∏
            redrawAreas(ctx);
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ canvas
            const newCanvas = canvas.cloneNode(false);
            canvas.parentNode.replaceChild(newCanvas, canvas);
            const canvasEl = document.getElementById('previewCanvas');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ canvas
            // –í–ê–ñ–ù–û: –¥–ª—è PDF –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∞ –Ω–µ —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã DPI 300
            // –†–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
            if (baseElement) {
                // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                let realWidth, realHeight;
                let displayWidth, displayHeight;
                
                if (baseElement.tagName === 'IMG') {
                    // –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º naturalWidth/naturalHeight (—Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã)
                    realWidth = baseElement.naturalWidth || baseElement.width;
                    realHeight = baseElement.naturalHeight || baseElement.height;
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                    displayWidth = baseElement.offsetWidth || baseElement.clientWidth;
                    displayHeight = baseElement.offsetHeight || baseElement.clientHeight;
                } else if (baseElement.tagName === 'CANVAS') {
                    // –î–ª—è PDF canvas - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–µ —Ä–µ–∞–ª—å–Ω—ã–µ DPI 300!)
                    // –†–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã PDF —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ dataset –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    realWidth = baseElement.width;  // –†–∞–∑–º–µ—Ä—ã —Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω–æ–≥–æ canvas
                    realHeight = baseElement.height;
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                    displayWidth = baseElement.offsetWidth || baseElement.clientWidth;
                    displayHeight = baseElement.offsetHeight || baseElement.clientHeight;
                    
                    console.log(`PDF canvas: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ${realWidth}x${realHeight} (—Ä–µ–∞–ª—å–Ω—ã–µ PDF ${baseElement.dataset.pdfRealWidth || 'N/A'}x${baseElement.dataset.pdfRealHeight || 'N/A'})`);
                } else {
                    const rect = baseElement.getBoundingClientRect();
                    realWidth = rect.width || baseElement.offsetWidth;
                    realHeight = rect.height || baseElement.offsetHeight;
                    displayWidth = rect.width;
                    displayHeight = rect.height;
                }
                
                console.log(`–ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas: —Ä–∞–∑–º–µ—Ä—ã ${realWidth}x${realHeight}, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ ${displayWidth}x${displayHeight}`);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–º–µ—Ä—ã canvas —Ä–∞–≤–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                // –î–ª—è PDF —ç—Ç–æ —Ä–∞–∑–º–µ—Ä—ã —Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω–æ–≥–æ canvas, –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                canvasEl.width = realWidth;
                canvasEl.height = realHeight;
                
                // –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                canvasEl.style.width = displayWidth + 'px';
                canvasEl.style.height = displayHeight + 'px';
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                const scaleX = realWidth / displayWidth;
                const scaleY = realHeight / displayHeight;
                canvasEl.dataset.scaleX = scaleX;
                canvasEl.dataset.scaleY = scaleY;
                
                console.log(`Canvas –Ω–∞—Å—Ç—Ä–æ–µ–Ω: —Ä–∞–∑–º–µ—Ä ${canvasEl.width}x${canvasEl.height}, –º–∞—Å—à—Ç–∞–± ${scaleX.toFixed(2)}x${scaleY.toFixed(2)}`);
            }
            canvasEl.style.position = 'absolute';
            canvasEl.style.top = '0';
            canvasEl.style.left = '0';
            canvasEl.style.zIndex = '10';
            
            const newCtx = canvasEl.getContext('2d');
            redrawAreas(newCtx);
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è canvas, –∏ –¥–ª—è document)
            function handleMouseMove(e) {
                if (!isDrawing) return;
                e.preventDefault();
                e.stopPropagation();
                
                const rect = canvasEl.getBoundingClientRect();
                // –ú–∞—Å—à—Ç–∞–± –º–µ–∂–¥—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –∏ —Ä–µ–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º canvas
                const scaleX = canvasEl.width / rect.width;
                const scaleY = canvasEl.height / rect.height;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ canvas –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö
                let currentX = (e.clientX - rect.left) * scaleX;
                let currentY = (e.clientY - rect.top) * scaleY;
                
                // –ù–ï –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã - –ø–æ–∑–≤–æ–ª—è–µ–º –≤—ã–¥–µ–ª—è—Ç—å –∑–∞ –≤–∏–¥–∏–º—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
                // –ù–æ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç—å—é canvas
                const drawX = Math.max(0, Math.min(canvasEl.width, currentX));
                const drawY = Math.max(0, Math.min(canvasEl.height, currentY));
                const drawStartX = Math.max(0, Math.min(canvasEl.width, startX));
                const drawStartY = Math.max(0, Math.min(canvasEl.height, startY));
                
                newCtx.clearRect(0, 0, canvasEl.width, canvasEl.height);
                redrawAreas(newCtx);
                
                // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç—å—é)
                newCtx.strokeStyle = '#667eea';
                newCtx.lineWidth = 2;
                newCtx.setLineDash([5, 5]);
                newCtx.strokeRect(drawStartX, drawStartY, drawX - drawStartX, drawY - drawStartY);
                
                newCtx.fillStyle = 'rgba(102, 126, 234, 0.1)';
                newCtx.fillRect(drawStartX, drawStartY, drawX - drawStartX, drawY - drawStartY);
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
            function handleMouseUp(e) {
                if (!isDrawing) return;
                e.preventDefault();
                e.stopPropagation();
                isDrawing = false;
                
                // –£–¥–∞–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                
                const rect = canvasEl.getBoundingClientRect();
                // –ú–∞—Å—à—Ç–∞–± –º–µ–∂–¥—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –∏ —Ä–µ–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º canvas
                const scaleX = canvasEl.width / rect.width;
                const scaleY = canvasEl.height / rect.height;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö canvas
                let endX = (e.clientX - rect.left) * scaleX;
                let endY = (e.clientY - rect.top) * scaleY;
                
                // –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ canvas (—Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã)
                const finalStartX = Math.max(0, Math.min(canvasEl.width, startX));
                const finalStartY = Math.max(0, Math.min(canvasEl.height, startY));
                const finalEndX = Math.max(0, Math.min(canvasEl.width, endX));
                const finalEndY = Math.max(0, Math.min(canvasEl.height, endY));
                
                const area = {
                    x: Math.min(finalStartX, finalEndX),
                    y: Math.min(finalStartY, finalEndY),
                    width: Math.abs(finalEndX - finalStartX),
                    height: Math.abs(finalEndY - finalStartY)
                };
                
                console.log(`–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è: —Å—Ç–∞—Ä—Ç [${startX.toFixed(0)}, ${startY.toFixed(0)}], –∫–æ–Ω–µ—Ü [${endX.toFixed(0)}, ${endY.toFixed(0)}], –æ–±–ª–∞—Å—Ç—å [${area.x.toFixed(0)}, ${area.y.toFixed(0)}, ${area.width.toFixed(0)}, ${area.height.toFixed(0)}]`);
                
                if (area.width > 10 && area.height > 10) {
                    selectedAreas.push(area);
                    console.log(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±–ª–∞—Å—Ç—å ${selectedAreas.length}: [${area.x}, ${area.y}, ${area.width}, ${area.height}]`);
                    updateAreasDisplay();
                    redrawAreas(newCtx);
                } else {
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –±–µ–∑ –Ω–æ–≤–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è
                    newCtx.clearRect(0, 0, canvasEl.width, canvasEl.height);
                    redrawAreas(newCtx);
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
            canvasEl.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                isDrawing = true;
                const rect = canvasEl.getBoundingClientRect();
                // –ú–∞—Å—à—Ç–∞–± –º–µ–∂–¥—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –∏ —Ä–µ–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º canvas
                const scaleX = canvasEl.width / rect.width;
                const scaleY = canvasEl.height / rect.height;
                startX = (e.clientX - rect.left) * scaleX;
                startY = (e.clientY - rect.top) * scaleY;
                
                console.log(`–ù–∞—á–∞–ª–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è: –∫–ª–∏–∫ [${e.clientX}, ${e.clientY}], rect [${rect.left}, ${rect.top}, ${rect.width}, ${rect.height}], canvas [${canvasEl.width}, ${canvasEl.height}], –º–∞—Å—à—Ç–∞–± [${scaleX.toFixed(2)}, ${scaleY.toFixed(2)}], —Å—Ç–∞—Ä—Ç [${startX.toFixed(0)}, ${startY.toFixed(0)}]`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º—ã—à–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ canvas
                document.addEventListener('mousemove', handleMouseMove, { passive: false });
                document.addEventListener('mouseup', handleMouseUp, { passive: false });
            }, { passive: false });
            
            // –õ–æ–∫–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ –Ω–∞ canvas (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞)
            canvasEl.addEventListener('mousemove', handleMouseMove, { passive: false });
            
            // –£–±–∏—Ä–∞–µ–º mouseleave - —Ç–µ–ø–µ—Ä—å –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
            
            // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ touch —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            canvasEl.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    bubbles: true
                });
                canvasEl.dispatchEvent(mouseEvent);
            }, { passive: false });
            
            canvasEl.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    bubbles: true
                });
                canvasEl.dispatchEvent(mouseEvent);
            }, { passive: false });
            
            canvasEl.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {
                    bubbles: true
                });
                canvasEl.dispatchEvent(mouseEvent);
            }, { passive: false });
            
        }
        
        function redrawAreas(ctx) {
            if (!ctx) return;
            selectedAreas.forEach((area, index) => {
                ctx.strokeStyle = index % 2 === 0 ? '#667eea' : '#764ba2';
                ctx.lineWidth = 2;
                ctx.setLineDash([]);
                ctx.strokeRect(area.x, area.y, area.width, area.height);
                
                ctx.fillStyle = index % 2 === 0 ? 'rgba(102, 126, 234, 0.2)' : 'rgba(118, 75, 162, 0.2)';
                ctx.fillRect(area.x, area.y, area.width, area.height);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –æ–±–ª–∞—Å—Ç–∏
                ctx.fillStyle = index % 2 === 0 ? '#667eea' : '#764ba2';
                ctx.font = '14px Arial';
                ctx.fillText((index + 1).toString(), area.x + 5, area.y + 18);
            });
        }
        
        function updateAreasDisplay() {
            document.getElementById('areasCount').textContent = `–í—ã–¥–µ–ª–µ–Ω–æ –æ–±–ª–∞—Å—Ç–µ–π: ${selectedAreas.length}`;
            
            const areasDiv = document.getElementById('selectedAreas');
            areasDiv.innerHTML = '';
            
            selectedAreas.forEach((area, index) => {
                const areaItem = document.createElement('div');
                areaItem.className = 'area-item';
                areaItem.innerHTML = `
                    <div>
                        <strong>–û–±–ª–∞—Å—Ç—å ${index + 1}:</strong> 
                        X: ${Math.round(area.x)}, Y: ${Math.round(area.y)}, 
                        –®: ${Math.round(area.width)}, –í: ${Math.round(area.height)}
                    </div>
                    <button onclick="removeArea(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                `;
                areasDiv.appendChild(areaItem);
            });
        }
        
        function removeArea(index) {
            selectedAreas.splice(index, 1);
            updateAreasDisplay();
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            redrawAreas(ctx);
        }
        
        document.getElementById('clearAreasBtn').addEventListener('click', () => {
            selectedAreas = [];
            updateAreasDisplay();
            const canvas = document.getElementById('previewCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }
        });
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            const template = document.getElementById('template').value;
            if (template) {
                formData.append('template', template);
            }
            
            const requiredFields = document.getElementById('requiredFields').value;
            if (requiredFields) {
                formData.append('required_fields', requiredFields);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
            if (selectedAreas.length > 0) {
                const canvas = document.getElementById('previewCanvas');
                const baseElement = document.getElementById('previewImage') || document.querySelector('#previewContainer canvas:not(#previewCanvas)');
                
                if (canvas) {
                    // –î–ª—è PDF: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ canvas –≤ —Ä–∞–∑–º–µ—Ä–∞—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞—Å—à—Ç–∞–± 1.5)
                    // –ù—É–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –¥–æ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ PDF (DPI 300)
                    // –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∂–µ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö
                    
                    let scaleX = 1.0, scaleY = 1.0;
                    
                    if (baseElement && baseElement.tagName === 'CANVAS' && baseElement.dataset.pdfRealWidth) {
                        // –î–ª—è PDF: –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –æ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫ —Ä–µ–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–∞–º PDF (DPI 300)
                        const pdfRealWidth = parseFloat(baseElement.dataset.pdfRealWidth);
                        const pdfRealHeight = parseFloat(baseElement.dataset.pdfRealHeight);
                        const pdfDisplayWidth = parseFloat(baseElement.dataset.pdfDisplayWidth) || baseElement.width;
                        const pdfDisplayHeight = parseFloat(baseElement.dataset.pdfDisplayHeight) || baseElement.height;
                        
                        scaleX = pdfRealWidth / pdfDisplayWidth;
                        scaleY = pdfRealHeight / pdfDisplayHeight;
                        
                        console.log(`PDF –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${pdfDisplayWidth}x${pdfDisplayHeight} -> —Ä–µ–∞–ª—å–Ω—ã–π ${pdfRealWidth.toFixed(0)}x${pdfRealHeight.toFixed(0)}, –º–∞—Å—à—Ç–∞–± ${scaleX.toFixed(3)}x${scaleY.toFixed(3)}`);
                    } else if (baseElement && baseElement.tagName === 'IMG') {
                        // –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∂–µ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö
                        scaleX = 1.0;
                        scaleY = 1.0;
                        console.log(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∂–µ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö`);
                    }
                    
                    const areasToSend = selectedAreas.map((area, index) => {
                        // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è PDF –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                        const x1 = Math.round(area.x * scaleX);
                        const y1 = Math.round(area.y * scaleY);
                        const x2 = Math.round((area.x + area.width) * scaleX);
                        const y2 = Math.round((area.y + area.height) * scaleY);
                        
                        console.log(`–û–±–ª–∞—Å—Ç—å ${index + 1}: canvas [${area.x.toFixed(0)}, ${area.y.toFixed(0)}, ${area.width.toFixed(0)}, ${area.height.toFixed(0)}] -> –æ—Ç–ø—Ä–∞–≤–∫–∞ [${x1}, ${y1}, ${x2}, ${y2}] (–º–∞—Å—à—Ç–∞–± ${scaleX.toFixed(3)}x${scaleY.toFixed(3)})`);
                        
                        return { x1, y1, x2, y2 };
                    });
                    
                    formData.append('selected_areas', JSON.stringify(areasToSend));
                } else {
                    console.warn('Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã');
                }
            }
            
            submitBtn.disabled = true;
            loading.classList.add('show');
            results.classList.remove('show');
            
            try {
                const response = await fetch('/api/v1/process', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                loading.classList.remove('show');
            }
        });
        
        function displayResults(data) {
            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            const warnings = data.quality_report.warnings || [];
            const issues = data.quality_report.issues || [];
            const handwrittenAreas = data.quality_report.handwritten_areas || [];
            
            let warningsHtml = '';
            
            if (warnings.length > 0) {
                warnings.forEach(warning => {
                    warningsHtml += `<div class="warning">
                        <div class="warning-title">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</div>
                        <div class="warning-text">${warning}</div>
                    </div>`;
                });
            }
            
            if (issues.length > 0) {
                issues.forEach(issue => {
                    warningsHtml += `<div class="warning">
                        <div class="warning-title">‚ö†Ô∏è ${issue.type}</div>
                        <div class="warning-text">${issue.message}</div>
                    </div>`;
                });
            }
            
            if (handwrittenAreas.length > 0) {
                warningsHtml += `<div class="warning">
                    <div class="warning-title">‚úçÔ∏è –†—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç</div>
                    <div class="warning-text">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${handwrittenAreas.length} –æ–±–ª–∞—Å—Ç–µ–π —Å –≤–æ–∑–º–æ–∂–Ω—ã–º —Ä—É–∫–æ–ø–∏—Å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º - –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å—Ç–µ</div>
                </div>`;
            }
            
            if (warningsHtml) {
                document.getElementById('warningsInfo').innerHTML = warningsHtml;
                document.getElementById('warningsSection').style.display = 'block';
            } else {
                document.getElementById('warningsSection').style.display = 'none';
            }
            
            // –í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ (DPI 900)
            const selectedAreas = data.extracted_data.selected_areas || [];
            if (selectedAreas.length > 0) {
                let areasHtml = '';
                selectedAreas.forEach(area => {
                    const coords = area.coordinates || {};
                    areasHtml += `<div class="selected-area-result" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #667eea; margin-bottom: 10px;">
                            üéØ –û–±–ª–∞—Å—Ç—å ${area.area_number || 'N/A'} (DPI ${area.dpi || 900})
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: X1:${coords.x1 || 0}, Y1:${coords.y1 || 0}, X2:${coords.x2 || 0}, Y2:${coords.y2 || 0}
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd; white-space: pre-wrap; font-family: monospace; line-height: 1.6;">
                            ${escapeHtml(area.text || '–¢–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω')}
                        </div>
                    </div>`;
                });
                document.getElementById('selectedAreasInfo').innerHTML = areasHtml;
                document.getElementById('selectedAreasSection').style.display = 'block';
            } else {
                document.getElementById('selectedAreasSection').style.display = 'none';
            }
            
            // –í—ã–¥–µ–ª—è–µ–º—ã–µ –æ–±–ª–∞—Å—Ç–∏ (—Å—Ç–∞—Ä—ã–π –∫–æ–¥ –¥–ª—è text_regions)
            const textRegions = data.quality_report.text_regions || [];
            let areasHtml = '';
            
            if (textRegions.length > 0) {
                areasHtml += `<p><strong>–í—Å–µ–≥–æ –æ–±–ª–∞—Å—Ç–µ–π —Ç–µ–∫—Å—Ç–∞:</strong> ${textRegions.length}</p>`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 –æ–±–ª–∞—Å—Ç–µ–π
                const regionsToShow = textRegions.slice(0, 10);
                regionsToShow.forEach((region, index) => {
                    const bbox = region.bbox || {};
                    areasHtml += `
                        <div class="area-info">
                            <strong>–û–±–ª–∞—Å—Ç—å ${index + 1}:</strong> "${region.text.substring(0, 50)}${region.text.length > 50 ? '...' : ''}"
                            <div class="area-coords">
                                <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong><br>
                                X: ${bbox.x?.toFixed(0) || bbox.x1?.toFixed(0) || 'N/A'}, 
                                Y: ${bbox.y?.toFixed(0) || bbox.y1?.toFixed(0) || 'N/A'}<br>
                                –®–∏—Ä–∏–Ω–∞: ${bbox.width?.toFixed(0) || 'N/A'}, 
                                –í—ã—Å–æ—Ç–∞: ${bbox.height?.toFixed(0) || 'N/A'}<br>
                                –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(region.confidence * 100).toFixed(2)}%
                            </div>
                        </div>
                    `;
                });
                
                if (textRegions.length > 10) {
                    areasHtml += `<p style="margin-top: 10px; color: #666;">... –∏ –µ—â—ë ${textRegions.length - 10} –æ–±–ª–∞—Å—Ç–µ–π</p>`;
                }
            }
            
            if (handwrittenAreas.length > 0) {
                handwrittenAreas.forEach((area, index) => {
                    const bbox = area.area || {};
                    areasHtml += `
                        <div class="area-info" style="border-left-color: #ff9800;">
                            <strong>‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å ${index + 1} (—Ä—É–∫–æ–ø–∏—Å–Ω—ã–π —Ç–µ–∫—Å—Ç):</strong> "${area.text.substring(0, 50)}${area.text.length > 50 ? '...' : ''}"
                            <div class="area-coords">
                                <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong><br>
                                X1: ${bbox.x1?.toFixed(0) || 'N/A'}, Y1: ${bbox.y1?.toFixed(0) || 'N/A'}<br>
                                X2: ${bbox.x2?.toFixed(0) || 'N/A'}, Y2: ${bbox.y2?.toFixed(0) || 'N/A'}<br>
                                –°—Ç—Ä–∞–Ω–∏—Ü–∞: ${area.page_number || 'N/A'}, –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(area.confidence * 100).toFixed(2)}%
                            </div>
                        </div>
                    `;
                });
            }
            
            // –¢–µ–∫—Å—Ç
            const fullText = data.extracted_data.full_text || '–¢–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω';
            document.getElementById('textOutput').textContent = fullText;
            
            results.classList.add('show');
            results.scrollIntoView({ behavior: 'smooth' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

